# 세션 관리 시스템 구현 작업 목록

- [ ] 1. 테스트 인프라 설정 및 기본 테스트 구현

- [ ] 1.1 테스트 환경 설정 및 기본 테스트 구조 생성
  - test/ 디렉토리에 session_management/ 폴더 구조 생성
  - 테스트용 데이터베이스 연결 및 모킹 설정
  - Riverpod 테스트 컨테이너 설정
  - 기본 테스트 헬퍼 함수 작성
  - _요구사항: 전체 테스트 기반_

- [ ] 1.2 StopwatchProvider 단위 테스트 작성
  - StopwatchState 모델의 기본 동작 테스트 (elapsed, isRunning)
  - start, pause, resume, stop, reset 메서드 단위 테스트
  - setElapsed 메서드 테스트 (외부 누적 시간 설정)
  - 타이머 정확도 테스트 (±50ms 허용 오차)
  - 메모리 누수 방지를 위한 리소스 정리 테스트
  - _요구사항: 7.1, 7.2, 7.3_

- [ ] 2. 데이터베이스 세션 라이프사이클 테스트 구현

- [ ] 2.1 세션 시작 로직 테스트
  - 새 세션 생성 시 running 상태 설정 테스트
  - 활성 세션 존재 시 StateError 예외 발생 테스트
  - lastStartedAt 필드 정확한 설정 테스트
  - 트랜잭션 내에서 세션 생성 원자성 테스트
  - _요구사항: 1.1, 1.5, 5.1, 5.2_

- [ ] 2.2 세션 일시정지 로직 테스트
  - running → paused 상태 전환 테스트
  - elapsedMs 누적 계산 정확성 테스트
  - lastStartedAt null 설정 테스트
  - 잘못된 상태에서 pause 호출 시 예외 처리 테스트
  - _요구사항: 2.1, 2.2, 2.3, 2.4, 5.4_

- [ ] 2.3 세션 재개 로직 테스트
  - paused → running 상태 전환 테스트
  - lastStartedAt 재설정 테스트
  - 기존 elapsedMs 값 유지 테스트
  - 잘못된 상태에서 resume 호출 시 예외 처리 테스트
  - _요구사항: 3.1, 3.2, 3.3, 3.4_

- [x] 2.4 세션 중지 로직 테스트
  - running/paused → stopped 상태 전환 테스트
  - 최종 경과 시간 계산 및 저장 테스트
  - stoppedAt 필드 설정 테스트
  - 라벨/메모 저장 기능 테스트 (null 처리 포함)
  - _요구사항: 4.2, 4.3, 4.4, 4.5_

- [x] 3. 세션 상태 불변 조건 및 데이터 무결성 테스트

- [x] 3.1 프로젝트별 단일 활성 세션 규칙 테스트
  - getActiveSession 메서드 정확성 테스트
  - 활성 세션 존재 시 새 세션 시작 방지 테스트
  - 상태 전환 시 불변 조건 유지 테스트
  - 동시성 상황에서 중복 활성 세션 방지 테스트
  - _요구사항: 5.1, 5.2_

- [x] 3.2 세션 상태별 필드 검증 테스트
  - running 상태 시 lastStartedAt 필수 검증
  - paused/stopped 상태 시 lastStartedAt null 검증
  - 상태 전환 시 필드 일관성 검증
  - 데이터베이스 제약 조건 테스트
  - _요구사항: 5.3, 5.4_
- [x] 4. 누적 시간 계산 정확성 테스트

- [x] 4.1 totalElapsedDuration 메서드 테스트
  - stopped 세션들의 합계 계산 테스트
  - 활성 세션 포함 총 누적 시간 계산 테스트
  - running 상태 세션의 실시간 시간 계산 테스트
  - paused 상태 세션의 정확한 시간 계산 테스트
  - _요구사항: 5.5_

- [x] 4.2 화면 진입 시 초기 누적 시간 표시 테스트
  - 완료된 세션들과 활성 세션을 포함한 총 누적 시간 정확한 표시 테스트
  - UI 초기화 시 DB 기준 시간 복원 테스트 (_refreshFromDB 메서드)
  - 활성 세션 상태(running/paused)에 따른 시간 계산 정확성 테스트
  - _요구사항: 7.4, 5.5_

- [x] 4.3 세션 라이프사이클 전체에서 누적 시간 정확성 테스트
  - 새 세션 시작 시 기존 누적 시간 연속성 테스트
  - 일시정지/재개 과정에서 시간 정확성 테스트
  - 세션 완료 후 총 누적 시간 정확성 테스트
  - 세션 초기화 후 누적 시간 복원 테스트
  - _요구사항: 1.1, 2.1, 3.1, 4.2, 6.1, 6.2, 6.3_

- [x] 5. UI 컴포넌트 통합 테스트

- [x] 5.1 StopwatchPanel 위젯 테스트
  - 초기 상태 렌더링 테스트 (시간 표시, 버튼 상태)
  - 시작 버튼 클릭 시 새 세션 생성 및 UI 업데이트 테스트
  - 일시정지 버튼 클릭 시 상태 변경 및 UI 업데이트 테스트
  - 랩 버튼 클릭 시 세션 종료 다이얼로그 표시 테스트
  - 초기화 버튼 클릭 시 세션 리셋 및 UI 복원 테스트
  - _요구사항: 1.1, 2.1, 3.1, 4.1, 6.1, 6.2, 6.3_

- [x] 5.2 활성 세션 존재 시 이어하기/새로 시작 다이얼로그 테스트
  - paused 상태 활성 세션 존재 시 다이얼로그 표시 테스트
  - 이어하기 선택 시 기존 세션 재개 테스트
  - 새로 시작 선택 시 기존 세션 종료 후 새 세션 생성 테스트
  - 다이얼로그 취소 시 상태 유지 테스트
  - _요구사항: 1.2, 1.3, 1.4_

- [x] 6. 세션 종료 및 라벨 관리 테스트

- [x] 6.1 세션 종료 다이얼로그 테스트
  - EndSessionSheetCupertino/Material 렌더링 테스트
  - 라벨 선택 및 메모 입력 기능 테스트
  - 저장 버튼 클릭 시 세션 완료 및 데이터 저장 테스트
  - 취소 버튼 클릭 시 세션 상태 유지 테스트
  - _요구사항: 4.1, 4.5_

- [x] 6.2 플랫폼별 라벨 선택기 테스트
  - iOS: CupertinoModalBottomSheet 렌더링 및 라벨 선택 테스트
  - Android: Material BottomSheet 및 ChoiceChip 기반 라벨 선택 테스트
  - 라벨 관리 기능 (추가/삭제) 테스트
  - 미분류 라벨 선택 테스트
  - _요구사항: 4.5_

- [x] 7. 에러 처리 및 예외 상황 테스트

- [x] 7.1 상태 전환 에러 처리 테스트
  - 잘못된 상태에서 메서드 호출 시 StateError 발생 테스트
  - UI에서 에러 발생 시 사용자 친화적 메시지 표시 테스트
  - 에러 발생 후 시스템 복구 및 상태 일관성 테스트
  - 빠른 버튼 클릭 시 중복 처리 방지 테스트 (_busy 플래그)
  - _요구사항: 5.2_

- [x] 7.2 데이터베이스 트랜잭션 및 동시성 테스트
  - 트랜잭션 실패 시 롤백 테스트
  - 동시 세션 조작 시 데이터 무결성 테스트
  - 데이터베이스 연결 오류 시 처리 테스트
  - 타이머 업데이트와 사용자 액션 동시 발생 시 처리 테스트
  - _요구사항: 5.1, 5.2_

- [x] 8. 성능 및 메모리 관리 테스트

- [x] 8.1 타이머 리소스 관리 테스트
  - StopwatchProvider dispose 시 타이머 정리 테스트
  - 메모리 누수 방지 테스트
  - 백그라운드/포그라운드 전환 시 정확한 시간 계산 테스트
  - 50ms 주기 타이머의 성능 영향 테스트
  - _요구사항: 7.3_

- [x] 8.2 대용량 데이터 처리 테스트
  - 다수의 완료된 세션 존재 시 성능 테스트
  - 스트림 기반 실시간 데이터 업데이트 테스트 (watchCompletedSessions)
  - ListView 렌더링 성능 테스트
  - 누적 시간 계산 성능 테스트
  - _요구사항: 5.5_

- [x] 9. 통합 테스트 및 엔드투엔드 시나리오

- [x] 9.1 전체 세션 라이프사이클 시나리오 테스트
  - 화면 진입 → 세션 시작 → 일시정지 → 재개 → 완료 전체 플로우 테스트
  - 여러 세션 생성 및 완료 후 누적 시간 정확성 테스트
  - 세션 초기화 및 복원 시나리오 테스트
  - 라벨 변경 및 메모 추가를 포함한 완전한 워크플로우 테스트
  - _요구사항: 1.1~7.4 전체_

- [x] 9.2 코드 품질 개선 및 최종 검증
  - 기존 코드의 deprecated API 수정 (withOpacity → withValues)
  - 사용하지 않는 코드 제거 (_Lap 클래스, 미사용 파라미터)
  - 테스트 커버리지 검증 및 누락된 테스트 케이스 보완
  - 성능 프로파일링 및 최적화 검증
  - _요구사항: 코드 품질 및 유지보수성_