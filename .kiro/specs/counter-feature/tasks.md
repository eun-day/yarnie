# 구현 계획

- [x] 1. 데이터베이스 테이블 추가
  - lib/db/app_db.dart에 ProjectCounters 테이블 정의 추가
  - 테이블 스키마: projectId(PK), mainCounter, mainCountBy, subCounter, subCountBy, hasSubCounter
  - dart run build_runner build 실행하여 코드 생성
  - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [x] 2. 카운터 데이터 모델 생성
  - lib/model/counter_data.dart 파일 생성
  - CounterData 클래스 구현 (projectId, mainCounter, mainCountBy, subCounter, subCountBy, hasSubCounter 필드)
  - Drift 테이블과 연동되는 데이터 모델 구현
  - _요구사항: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3_

- [x] 3. 카운터 프로바이더 구현
- [x] 3.1 기본 카운터 상태 관리 구현
  - lib/providers/counter_provider.dart 파일 생성
  - CounterState 클래스 구현 (projectId 필드 포함, copyWith 메서드 포함)
  - CounterNotifier 클래스의 기본 구조 구현
  - 프로젝트별 초기화 로직 구현 (initializeForProject 메서드)
  - _요구사항: 3.1, 4.2, 7.4_

- [x] 3.2 메인 카운터 조작 메서드 구현
  - incrementMain, decrementMain 메서드 구현 (countBy 단위로 증감)
  - resetMain 메서드 구현
  - setMainCountBy 메서드 구현
  - _요구사항: 3.1, 4.5, 5.3, 5.4_

- [x] 3.3 서브 카운터 관리 메서드 구현
  - addSubCounter, removeSubCounter 메서드 구현
  - incrementSub, decrementSub 메서드 구현 (서브 카운터의 countBy 단위로 증감)
  - resetSub 메서드 구현
  - setSubCountBy 메서드 구현
  - _요구사항: 2.1, 3.1, 4.5_

- [x] 3.4 데이터베이스 데이터 지속성 구현
  - _saveToDatabase 메서드 구현 (프로젝트별 카운터 데이터를 DB에 저장)
  - _loadFromDatabase 메서드 구현 (프로젝트 ID로 카운터 데이터 로드)
  - 에러 처리 로직 구현 (저장/로드 실패 시 기본값 사용)
  - 새 프로젝트 시 기본 레코드 생성 로직 구현
  - _요구사항: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

- [x] 4. 카운터 표시 위젯 구현
- [x] 4.1 메인 카운터 표시 기능 구현
  - _CounterView 내에서 직접 메인 카운터 숫자 표시 구현
  - 큰 숫자를 중앙정렬로 표시하는 UI 구현
  - 터치 시 초기화 확인 다이얼로그 표시 기능 구현
  - 플랫폼별 다이얼로그 스타일 적용 (iOS: CupertinoAlertDialog, Android: AlertDialog)
  - _요구사항: 3.1, 3.2, 8.1, 8.2, 8.3_

- [x] 4.2 서브 카운터 아이템 위젯 생성
  - lib/widget/sub_counter_item.dart 파일 생성
  - "- [ 숫자 ] +" 형태의 간소한 UI 구현
  - 서브 카운터 증감 버튼 기능 구현
  - 삭제 버튼 기능 구현
  - _요구사항: 2.1_

- [x] 5. Count By 설정 위젯 구현
- [x] 5.1 Count By 선택기 위젯 생성
  - lib/widget/count_by_selector.dart 파일 생성
  - "count by X" 버튼 UI 구현
  - 현재 설정된 count by 값 표시 기능 구현
  - _요구사항: 4.1, 4.2_

- [x] 5.2 Count By 설정 팝업 구현
  - 휠피커를 사용한 숫자 선택 팝업 구현
  - 플랫폼별 피커 스타일 적용 (iOS: CupertinoPicker, Android: ListWheelScrollView)
  - 1-10 범위의 숫자 선택 기능 구현
  - 확인/취소 버튼 기능 구현
  - _요구사항: 4.3, 4.4, 8.1, 8.2, 8.3_

- [x] 6. 메인 카운터 화면 UI 구현
- [x] 6.1 스톱워치 표시 영역 구현
  - 카운터 화면 최상단에 항상 표시되는 스톱워치 영역 구현
  - 스톱워치 시간 표시 및 시작/일시정지 버튼 구현
  - stopwatchProvider와의 연동 로직 구현
  - _요구사항: 1.1, 1.2, 1.3_

- [x] 6.2 카운터 추가 버튼 구현
  - "카운터 추가" 버튼 UI 구현
  - 서브 카운터가 이미 있을 때는 버튼 비활성화 또는 숨김 처리
  - 버튼 클릭 시 서브 카운터 생성 기능 구현
  - _요구사항: 2.1_

- [x] 6.3 메인 카운터 영역 구성
  - _CounterView 내에서 직접 메인 카운터 숫자 표시
  - 메인 카운터용 CountBySelector 위젯 배치
  - 적절한 레이아웃과 스타일링 적용
  - _요구사항: 3.1, 4.1, 4.2_

- [x] 6.4 메인 카운터 +/- 버튼 영역 구현
  - 화면 너비를 절반씩 차지하는 세로로 긴 - 버튼과 + 버튼 구현
  - 버튼 클릭 시 메인 카운터 증감 기능 구현
  - 플랫폼별 버튼 스타일 적용
  - _요구사항: 5.1, 5.2, 5.3, 5.4, 8.1, 8.2, 8.3_

- [x] 6.5 서브 카운터 영역 구성
  - 서브 카운터가 있을 때만 표시되는 조건부 렌더링 구현
  - SubCounterItem 위젯을 사용한 서브 카운터 표시
  - 서브 카운터용 CountBySelector 위젯 배치
  - _요구사항: 2.1, 4.1, 4.2_

- [x] 7. 기존 _CounterView 교체
- [x] 7.1 기존 _CounterView 클래스 백업 및 제거
  - project_detail_screen.dart에서 기존 _CounterView 클래스 주석 처리
  - 새로운 _CounterView 클래스 구현 준비
  - _요구사항: 모든 요구사항_

- [x] 7.2 새로운 _CounterView 클래스 구현
  - ConsumerStatefulWidget으로 새로운 _CounterView 클래스 구현
  - counterProvider 연동 및 상태 구독 구현
  - 앞서 구현한 모든 위젯들을 조합한 완전한 카운터 화면 구성
  - 플랫폼별 레이아웃 최적화
  - _요구사항: 모든 요구사항_

- [x] 8. 통합 테스트 및 버그 수정
- [x] 8.1 카운터 기능 전체 플로우 테스트
  - 메인 카운터 증감, 초기화 기능 테스트
  - 서브 카운터 생성, 조작, 삭제 기능 테스트
  - count by 설정 기능 테스트
  - 스톱워치 표시 기능 테스트
  - _요구사항: 모든 요구사항_

- [x] 8.2 데이터 지속성 테스트
  - 프로젝트별 카운터 값 저장/복원 테스트
  - 데이터베이스 저장/로드 기능 테스트
  - 서로 다른 프로젝트 간 데이터 격리 테스트
  - 에러 상황에서의 기본값 처리 테스트
  - _요구사항: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

- [x] 8.3 플랫폼별 UI 테스트
  - iOS에서 Cupertino 스타일 컴포넌트 동작 테스트
  - Android에서 Material Design 컴포넌트 동작 테스트
  - 다양한 화면 크기에서의 레이아웃 테스트
  - _요구사항: 8.1, 8.2, 8.3, 8.4_

- [x] 8.4 성능 최적화 및 최종 검토
  - 불필요한 리빌드 방지를 위한 Provider 최적화
  - 메모리 사용량 확인 및 최적화
  - 코드 리뷰 및 리팩토링
  - _요구사항: 모든 요구사항_
- [x] 9. UI 레이아웃 개선 (새로운 요구사항 반영)

- [x] 9.1 메인 카운터 영역 레이아웃 개선
  - count by 버튼을 먼저 배치하고 우측 정렬로 위치시키기
  - 그 다음에 메인 카운터 숫자를 중앙정렬로 배치
  - 카운터 숫자가 과도한 세로 공간을 차지하지 않도록 조정
  - _요구사항: 3.1, 4.1_

- [x] 9.2 +/- 버튼 영역 레이아웃 개선
  - 버튼들의 가로세로 비율을 1:1.5로 조정
  - 화면 너비를 정확히 반반씩 차지하도록 수정
  - 버튼들이 하단 네비게이션 바에 가려지지 않도록 적절한 여백 추가
  - _요구사항: 5.1, 5.2_

- [x] 9.3 "Add SubCounter" 버튼 배치 및 표시 로직 개선
  - +/- 버튼 아래에 "Add SubCounter" 버튼을 중앙정렬로 배치
  - 기존 "카운터 추가" 텍스트를 "Add SubCounter"로 변경
  - 서브 카운터가 있을 때는 버튼을 숨기고, 서브 카운터가 없을 때만 표시
  - 서브 카운터 삭제 시 버튼이 다시 나타나도록 조건부 렌더링 구현
  - _요구사항: 2.1, 5.5_

- [x] 9.4 서브 카운터 영역 배치 조정
  - 서브 카운터를 "Add SubCounter" 버튼 아래에 배치
  - 서브 카운터가 있을 때만 표시되는 조건부 렌더링 유지
  - 전체 레이아웃에서 적절한 위치와 여백 조정
  - _요구사항: 2.1_

- [x] 9.5 전체 레이아웃 구조 재구성
  - Column 기반의 새로운 레이아웃 구조 구현
  - 위에서 아래 순서: 스톱워치(항상 표시) → count by 버튼(우측 정렬) → 메인 카운터 숫자 → +/- 버튼 → Add SubCounter(조건부) → 서브 카운터(조건부)
  - Add SubCounter 버튼과 서브 카운터의 조건부 표시 로직 구현
  - 각 영역 간의 적절한 여백과 비율 설정
  - _요구사항: 3.1, 4.1, 5.1, 5.5_

- [x] 9.6 SafeArea 및 여백 처리 개선
  - 하단 네비게이션 바와의 충돌 방지를 위한 SafeArea 적용
  - 각 UI 요소들이 적절한 여백을 가지도록 Padding 조정
  - 화면 크기에 따른 반응형 레이아웃 구현
  - _요구사항: 5.1, 5.2_

- [ ] 10. 개선된 UI 테스트 및 검증
- [ ] 10.1 새로운 레이아웃 기능 테스트
  - count by 버튼이 카운터 숫자 오른쪽 상단에 올바르게 배치되는지 확인
  - +/- 버튼의 1:1.5 비율과 화면 너비 반반 분할 확인
  - "Add SubCounter" 버튼의 중앙정렬 배치 확인
  - 하단 네비게이션 바와의 충돌 없음 확인
  - _요구사항: 3.1, 4.1, 5.1, 5.2, 5.5_

- [ ] 10.2 다양한 화면 크기에서 레이아웃 테스트
  - 작은 화면에서 UI 요소들이 겹치지 않는지 확인
  - 큰 화면에서 적절한 비율과 여백 유지 확인
  - 가로/세로 화면 전환 시 레이아웃 안정성 확인
  - _요구사항: 모든 요구사항_

- [ ] 10.3 사용성 테스트 및 최종 조정
  - 실제 사용 시나리오에서 UI 편의성 확인
  - 버튼 크기와 터치 영역의 적절성 검증
  - 시각적 계층 구조와 가독성 확인
  - 필요시 미세 조정 및 최종 완성
  - _요구사항: 모든 요구사항_

- [x] 11. 데이터베이스 구조 변경 (SharedPreferences → Drift DB)
- [x] 11.1 ProjectCounters 테이블 추가
  - lib/db/app_db.dart에 ProjectCounters 테이블 클래스 추가
  - 테이블 스키마 정의: projectId(PK), mainCounter, mainCountBy, subCounter, subCountBy, hasSubCounter
  - AppDatabase 클래스에 projectCounters 테이블 추가
  - dart run build_runner build 실행하여 코드 생성
  - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [x] 11.2 CounterProvider DB 연동 수정
  - CounterState에 projectId 필드 추가
  - initializeForProject 메서드 구현 (프로젝트별 초기화)
  - _saveToDatabase 메서드로 변경 (기존 _saveToPrefs 대체)
  - _loadFromDatabase 메서드로 변경 (기존 _loadFromPrefs 대체)
  - 프로젝트별 데이터 격리 로직 구현
  - _요구사항: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

- [x] 11.3 CounterData 모델 수정
  - projectId 필드 추가
  - Drift 테이블과 연동되는 생성자 및 메서드 구현
  - 기존 JSON 직렬화 메서드를 DB 연동 메서드로 변경
  - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [x] 11.4 프로젝트 상세 화면 연동
  - project_detail_screen.dart에서 프로젝트 ID를 CounterProvider에 전달
  - 화면 진입 시 해당 프로젝트의 카운터 데이터 로드
  - 프로젝트 변경 시 카운터 상태 초기화 로직 구현
  - _요구사항: 모든 요구사항_

- [x] 11.5 기존 SharedPreferences 코드 제거
  - shared_preferences 의존성 제거 (다른 곳에서 사용하지 않는 경우)
  - SharedPreferences 관련 코드 정리
  - 테스트 코드에서 SharedPreferences 모킹 제거
  - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [x] 11.6 DB 구조 변경에 따른 테스트 수정
  - 통합 테스트에서 프로젝트별 데이터 격리 테스트 추가
  - 서로 다른 프로젝트 ID로 카운터 데이터 독립성 확인
  - 데이터베이스 저장/로드 테스트로 변경
  - SharedPreferences 관련 테스트를 DB 테스트로 변경
  - _요구사항: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

- [x] 12. 성능 최적화 - 디바운싱 구현
- [x] 12.1 CounterProvider 디바운싱 로직 구현
  - Timer 기반 디바운싱 메커니즘 구현 (200ms 지연)
  - 카운터 값 변경 시 즉시 메모리 상태 업데이트
  - _scheduleDbSave 메서드로 DB 저장 지연 처리
  - 기존 타이머 취소 후 새 타이머 설정하는 로직 구현
  - _요구사항: 6.1, 6.2, 6.4_

- [x] 12.2 강제 저장 로직 구현
  - Provider dispose 시 즉시 DB 저장 처리
  - 앱 생명주기 변화 감지하여 백그라운드 진입 시 저장
  - 화면 전환 시 현재 상태 즉시 저장
  - 타이머 정리 및 메모리 누수 방지 로직 구현
  - _요구사항: 6.1, 6.2, 6.3_

- [x] 12.3 기존 즉시 저장 로직 제거
  - incrementMain, decrementMain 등에서 즉시 DB 저장 제거
  - _loadFromDatabase 호출 제거 (메모리 상태만 사용)
  - DB 접근 최소화를 통한 성능 향상
  - 상태 변경 메서드들을 동기 메서드로 변경
  - _요구사항: 6.1, 6.2, 6.4_

- [x] 12.4 디바운싱 테스트 구현
  - 연속 카운터 변경 시 DB 저장 횟수 최소화 테스트
  - 200ms 지연 후 저장되는지 확인하는 테스트
  - Provider dispose 시 강제 저장 테스트
  - 메모리 상태와 DB 상태 동기화 테스트
  - _요구사항: 6.1, 6.2, 6.3, 6.4_

- [x] 12.5 성능 검증 및 최적화
  - 연속 탭 시 UI 반응성 확인
  - DB 접근 횟수 모니터링 및 최적화 검증
  - 메모리 사용량 및 타이머 정리 확인
  - 실제 사용 시나리오에서 성능 테스트
  - _요구사항: 6.4_